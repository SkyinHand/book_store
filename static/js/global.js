let database = {
    'data': [{
        'id': '1',
        'title': '散步的侵略者',
        'author': '前川知大',
        'country': '日',
        'price': 34,
        'count': 127,
        'cover': '../static/img/book_img/book_1.jpg'
    },{
        'id': '2',
        'title': '三十年战争史',
        'author': '彼得·威尔逊',
        'country': '英',
        'price': 44,
        'count': 107,
        'cover': '../static/img/book_img/book_2.jpg'
    },{
        'id': '3',
        'title': '六十个故事',
        'author': '迪诺·布扎蒂',
        'country': '意',
        'price': 41,
        'count': 137,
        'cover': '../static/img/book_img/book_3.jpg'
    },{
        'id': '4',
        'title': '诗人的思考',
        'author': '海伦·文德勒',
        'country': '美',
        'price': 48,
        'count': 187,
        'cover': '../static/img/book_img/book_4.jpg'
    },{
        'id': '5',
        'title': '项塔兰3',
        'author': '格里高利·大卫·罗伯兹',
        'country': '澳大利亚',
        'price': 34,
        'count': 47,
        'cover': '../static/img/book_img/book_5.jpg'
    },{
        'id': '6',
        'title': '隋唐世界帝国的形成',
        'author': '谷川道雄',
        'country': '日',
        'price': 54,
        'count': 507,
        'cover': '../static/img/book_img/book_6.jpg'
    },{
        'id': '7',
        'title': '抓落叶',
        'author': '汤米·巴特勒',
        'country': '美',
        'price': 64,
        'count': 167,
        'cover': '../static/img/book_img/book_7.jpg'
    },{
        'id': '8',
        'title': '漫步八十年代',
        'author': '老葛',
        'country': '中',
        'price': 84,
        'count': 187,
        'cover': '../static/img/book_img/book_8.jpg'
    },{
        'id': '9',
        'title': '一千亿种生活',
        'author': '蕾秋·乔伊斯',
        'country': '英',
        'price': 34,
        'count': 77,
        'cover': '../static/img/book_img/book_9.jpg'
    },{
        'id': '10',
        'title': '电影时代',
        'author': '保琳·凯尔',
        'country': '美',
        'price': 69,
        'count': 3,
        'cover': '../static/img/book_img/book_10.jpg'
    },{
        'id': '11',
        'title': '你就是孩子最好的玩具',
        'author': '金伯莉·布雷恩',
        'country': 'U',
        'price': 29.8,
        'count': 37,
        'cover': '../static/img/book_img/book_11.jpg'
    },{
        'id': '12',
        'title': '钝感力',
        'author': '渡边淳一',
        'country': '日',
        'price': 15,
        'count': 507,
        'cover': '../static/img/book_img/book_12.jpg'
    },{
        'id': '13',
        'title': '你当像鸟飞往你的山',
        'author': '塔拉·韦斯特弗',
        'country': '美',
        'price': 59,
        'count': 437,
        'cover': '../static/img/book_img/book_13.jpg'
    },{
        'id': '14',
        'title': '人间失格',
        'author': '太宰治',
        'country': '日',
        'price': 16,
        'count': 4370,
        'cover': '../static/img/book_img/book_14.jpg'
    },{
        'id': '15',
        'title': '正面管教',
        'author': '简·尼尔森 (Jane Nelsen)',
        'country': '美',
        'price': 29,
        'count': 276,
        'cover': '../static/img/book_img/book_15.jpg'
    },{
        'id': '16',
        'title': '人生海海',
        'author': '麦家',
        'country': '中',
        'price': 55,
        'count': 345,
        'cover': '../static/img/book_img/book_16.jpg'
    },{
        'id': '17',
        'title': '小熊和最好的爸爸（全7册）',
        'author': '阿兰德·丹姆 文 / 亚历克斯·沃尔弗 图',
        'country': 'U',
        'price': 35,
        'count': 156,
        'cover': '../static/img/book_img/book_17.jpg'
    },{
        'id': '18',
        'title': '乌合之众',
        'author': '勒庞',
        'country': '法',
        'price': 16,
        'count': 186,
        'cover': '../static/img/book_img/book_18.jpg'
    },{
        'id': '19',
        'title': '张嘉骅少年读经典系列',
        'author': 'U',
        'country': 'U',
        'price': 116,
        'count': 186,
        'cover': '../static/img/book_img/book_19.jpg'
    },{
        'id': '20',
        'title': '中华人民共和国民法典：实用版',
        'author': 'U',
        'country': '中',
        'price': 65,
        'count': 1000,
        'cover': '../static/img/book_img/book_20.jpg'
    },{
        'id': '21',
        'title': '明智的孩子',
        'author': '安吉拉·卡特（Angela Carter）',
        'country': '英',
        'price': 26,
        'count': 368,
        'cover': '../static/img/book_img/book_21.png'
    },{
        'id': '22',
        'title': '乔乔的奇妙冒险',
        'author': '荒木飞吕彦',
        'country': '日',
        'price': 125,
        'count': 944,
        'cover': '../static/img/book_img/book_22.png'
    },{
        'id': '23',
        'title': '平行宇宙的艺术',
        'author': '詹姆斯·西西利亚诺 | James Siciliano / 贾斯汀·罗兰 | Justin Roiland',
        'country': '美',
        'price': 168,
        'count': 224,
        'cover': '../static/img/book_img/book_23.png'
    },{
        'id': '24',
        'title': '冯至译文全集',
        'author': '歌德、海涅、里尔克等著',
        'country': '德·奥地利',
        'price': 428,
        'count': 224,
        'cover': '../static/img/book_img/book_24.png'
    },{
        'id': '25',
        'title': '碎片',
        'author': '埃莱娜·费兰特',
        'country': '意',
        'price': 69,
        'count': 376,
        'cover': '../static/img/book_img/book_25.png'
    },{
        'id': '26',
        'title': '刘勃历史三部曲',
        'author': '刘勃',
        'country': '中',
        'price': 38,
        'count': 326,
        'cover': '../static/img/book_img/book_26.png'
    }]
};

Date.prototype.Format = function (fmt) { // author: meizz
    var o = {
        "M+": this.getMonth() + 1, // 月份
        "d+": this.getDate(), // 日
        "H+": this.getHours(), // 小时
        "m+": this.getMinutes(), // 分
        "s+": this.getSeconds(), // 秒
        "q+": Math.floor((this.getMonth() + 3) / 3), // 季度
        "S": this.getMilliseconds() // 毫秒
    };
    if (/(y+)/.test(fmt))
        fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
    for (var k in o)
        if (new RegExp("(" + k + ")").test(fmt)) fmt = fmt.replace(RegExp.$1, (RegExp.$1.length === 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
    return fmt;
}

function getQueryString(variable)
{
    var query = window.location.search.substring(1);
    var vars = query.split("&");
    for (var i=0;i<vars.length;i++) {
        var pair = vars[i].split("=");
        if(pair[0] === variable){return pair[1];}
    }
    return null;
}

$('document').ready(function() {
    let searchMap = { 1 : 'id', 2 : 'title', 3: 'author', 4: 'country' };
    let currentSearchIndex = 1;

    // 将当前数据存储到Storage中，如果一开始没有赋值，则赋予初值，否则不赋予
    if(window.localStorage.getItem("database") === null) {
        window.localStorage.setItem("database", JSON.stringify(database));
    }
    // ============== 获取body ================

    let body = $('body');

    // ============== 添加导航条 ================

    body.prepend(`<nav class="navbar navbar-expand-lg navbar-light animate__animated animate__fadeIn" style="position: relative; z-index: 1500" id="logo-area">
        <a class="navbar-brand text-white" href="./home.html"><img src="../static/img/other/logo.png" alt="龙谷阅读">龙谷阅读</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav mr-auto" >
                <li class="nav-item active">
                    <a class="nav-link text-white" href="./browse.html">浏览图书</a>
                </li>
                <li class="nav-item dropdown" >
                    <a class="nav-link dropdown-toggle text-white" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        图书分类
                    </a>
                    <div class="dropdown-menu animate__animated animate__fadeIn" aria-labelledby="navbarDropdown">
                        <a class="dropdown-item" href="#">文学艺术</a>
                        <a class="dropdown-item" href="#">青春文学</a>
                        <a class="dropdown-item" href="#">励志经典</a>
                        <a class="dropdown-item" href="#">历史形势</a>
                        <a class="dropdown-item" href="#">社会科学</a>
                        <a class="dropdown-item" href="#">旅游文化</a>
                        <a class="dropdown-item" href="#">美食时尚</a>
                        <a class="dropdown-item" href="#">少儿科学</a>
                        <a class="dropdown-item" href="#">时事政治</a>
                        <a class="dropdown-item" href="#">其他全部</a>
                    </div>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-white" href="#">图书排行</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-white" href="#">图书下载</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-white" href="./aboutus.html">关于本站</a>
                </li>
            </ul>
            <p class="navbar-text text-white mr-5 h5" style="margin-bottom: 0" id="p-time">当前时间</p>
            <form class="form-inline my-2 my-lg-0">
                <input class="form-control mr-sm-2" id="searchBox" type="search" placeholder="请输入书籍ID" aria-label="Search">
                <div class="btn-group mr-sm-2">
                    <button type="button" id="drop-search-type" class="btn btn-success dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        搜索类型
                    </button>
                    <div class="dropdown-menu">
                        <a href="#" class="dropdown-item" dropdown-id="1">书籍ID</a>
                        <a href="#" class="dropdown-item" dropdown-id="2">书籍名称</a>
                        <a href="#" class="dropdown-item" dropdown-id="3">书籍作者</a>
                        <a href="#" class="dropdown-item" dropdown-id="4">作者国籍</a>
                    </div>
                </div>
                <button class="btn btn-info my-2 my-sm-0" type="button" id="search">搜索</button>
                <button class="btn btn-primary ml-2 my-sm-0" type="button" id="clear">清空</button>
            </form>
        </div>
    </nav>`)

    // ============= 添加底部栏 =================

    body.append(`<div class="footer-main animate__animated animate__fadeIn">
        <div class="container">
            <div class="footer-header">
                合作伙伴
            </div>
            <div class="friend-website">
                <a href="#" class="friend-link">掌阅书城</a>
            </div>
            <div class="copy-right">
                Copyright 2020 龙谷书城 All Rights Reserved.
            </div>
        </div>
    </div>`)

    // 获取当前时间并重新设置时间到导航栏
    $('#p-time').html(`当前时间：${new Date().Format('yyyy-MM-dd HH:mm:ss')}`);

    setInterval(function() {
        $('#p-time').html(`当前时间：${new Date().Format('yyyy-MM-dd HH:mm:ss')}`);
    }, 1000);

    // ============== 为BookList添加元素 ====================

    for(let i = 0; i < database['data'].length; i++) {
        $('.new-book-list').append(`<div class="card new-book-item" book-id = "${database['data'][i]['id']}">
                        <a href="#">
                            <img src="${database['data'][i]['cover']}" class="card-img-top" alt="${database['data'][i]['title']}">
                        </a>
                        <div class="card-body new-book-item-body">
                            <a class="card-title new-book-item-title text-center" href="#">
                                ${database['data'][i]['title']}
                            </a>
                            <p class="card-text new-book-item-text">
                                [${database['data'][i]['country']}]${database['data'][i]['author']}
                            </p>
                        </div>
                    </div>`)
    }

    // =============== 全局点击事件 ===============

    $('#search').click(function() {
        let searchContent = $('#searchBox').val();
        if(searchContent !== '') {
            window.location.href = "./search.html?" + searchMap[currentSearchIndex] + '=' + searchContent;
        } else {
            $('body').modalCreate('错误', '请检索内容是否填写完整！', '确定', 'modal-style', '', 'text-danger');
        }
    })

    $('.new-book-item').click(function() {
        // 点击一本书，跳转到详情界面，该界面展示该书籍的相关信息
        let currentIndex = $(this).attr('book-id');
        // 跳转界面
        window.location.href = './bookdetail.html?id=' + currentIndex;
    })

    $('.dropdown-item').click(function () {
        currentSearchIndex = $(this).attr('dropdown-id');
        $('#drop-search-type').html($(this).text());
        $('#searchBox').attr('placeholder', `请输入${$(this).text()}`);
    })

    $('#clear').click(function () {
        $('#searchBox').val('');
    })

})
